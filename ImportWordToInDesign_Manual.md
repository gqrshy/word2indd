# ImportWordToInDesign.jsx マニュアル

Word文書(.docx)をInDesignドキュメントにインポートし、自動でスタイル変換・ページ追加・フォント置換を行うスクリプトです。

---

## 目次

1. [概要](#概要)
2. [使用前の準備](#使用前の準備)
3. [スクリプトの実行方法](#スクリプトの実行方法)
4. [スクリプトの動作内容](#スクリプトの動作内容)
5. [設定のカスタマイズ](#設定のカスタマイズ)
6. [関数リファレンス](#関数リファレンス)
7. [トラブルシューティング](#トラブルシューティング)

---

## 概要

### このスクリプトでできること

- Word文書（.docx）をInDesignに読み込む
- Wordの段落スタイルをInDesignの段落スタイルに自動変換
- テキストが溢れた場合、自動でページ（見開き）を追加
- MS明朝フォントをBIZ UDゴシックに自動置換
- 表やアンカーオブジェクト内のテキストにスタイルを適用

### 動作環境

- Adobe InDesign 2025（それ以前のバージョンでも動作する可能性あり）
- Windows / macOS

---

## 使用前の準備

### 1. InDesignドキュメントの準備

スクリプトを実行する前に、以下が設定されたInDesignドキュメントを開いてください：

#### 必須：マスターページ

`H-本文マスター` という名前のマスターページが必要です。

> **マスターページの確認方法**
> 1. ページパネル（ウィンドウ → ページ）を開く
> 2. パネル上部のマスターページ一覧を確認
> 3. `H-本文マスター` があることを確認

#### 必須：段落スタイル

以下の段落スタイルがInDesignドキュメントに定義されている必要があります：

| InDesignのスタイル名 | 用途 |
|---------------------|------|
| 大見出し1 | 大項目（章タイトルなど） |
| 小項目 | 小項目（節タイトルなど） |
| Normal | 本文 |
| 演習タイトル | 演習のタイトル |
| 図番号 | 図や表の番号 |
| リスト | 箇条書きリスト |
| 番号リスト | 番号付きリスト |
| コード・コマンド | コードやコマンド |

> **段落スタイルの確認方法**
> 1. 段落スタイルパネル（ウィンドウ → スタイル → 段落スタイル）を開く
> 2. 上記のスタイルが存在することを確認

### 2. Word文書の準備

インポートするWord文書では、以下の段落スタイルを使用してください：

| Wordのスタイル名 | 変換先（InDesign） |
|-----------------|-------------------|
| 大項目 | 大見出し1 |
| 小項目 | 小項目 |
| 標準 | Normal |
| 演習タイトル | 演習タイトル |
| 図表番号 | 図番号 |
| リスト | リスト |
| 番号 | 番号リスト |

### 3. フォントの準備

フォント置換機能を使用する場合、以下のフォントがインストールされている必要があります：

- **BIZ UDゴシック Regular**（置換先フォント）

---

## スクリプトの実行方法

### 手順

1. **InDesignドキュメントを開く**
   - テンプレートまたは作業中のドキュメントを開きます

2. **スクリプトパネルを開く**
   - メニュー：ウィンドウ → ユーティリティ → スクリプト

3. **スクリプトを実行**
   - スクリプトパネルで `ImportWordToInDesign.jsx` をダブルクリック

4. **Word文書を選択**
   - ファイル選択ダイアログが表示されるので、インポートする `.docx` ファイルを選択

5. **確認ダイアログで「はい」をクリック**
   - 処理内容の確認ダイアログが表示されます
   - 内容を確認して「はい」をクリック

6. **処理完了を待つ**
   - 処理が完了すると結果ダイアログが表示されます

### スクリプトの配置場所

スクリプトは以下のいずれかの場所に配置してください：

**Windows:**
```
C:\Users\<ユーザー名>\AppData\Roaming\Adobe\InDesign\Version <バージョン>\<言語>\Scripts\Scripts Panel\
```

**macOS:**
```
~/Library/Preferences/Adobe InDesign/Version <バージョン>/<言語>/Scripts/Scripts Panel/
```

> スクリプトパネルで「ユーザー」フォルダを右クリック →「エクスプローラーで表示」（Windows）または「Finderで表示」（macOS）で場所を開けます。

---

## スクリプトの動作内容

### 処理の流れ

```
1. マスターページの確認
       ↓
2. Word文書の選択
       ↓
3. 確認ダイアログ表示
       ↓
4. Word文書のインポート
       ↓
5. オーバーフロー時のページ自動追加
       ↓
6. 段落スタイルの変換
       ↓
7. 小項目への□記号追加
       ↓
8. フォント置換（MS明朝Bold → BIZ UDゴシック）
       ↓
9. アンカーオブジェクト内テキストにスタイル適用
       ↓
10. 表セル内テキストにスタイル適用
       ↓
11. 全表のフォント更新
       ↓
12. 完了ダイアログ表示
```

### 段落スタイル変換の詳細

| 変換元（Word） | 変換先（InDesign） | 追加処理 |
|---------------|-------------------|---------|
| 大項目 | 大見出し1 | 先頭の■記号を削除 |
| 小項目 | 小項目 | □記号を先頭に追加 |
| 標準 | Normal | - |
| 演習タイトル | 演習タイトル | - |
| 図表番号 | 図番号 | - |
| リスト | リスト | - |
| 番号 | 番号リスト | - |

### フォント置換の詳細

以下のフォントが検出された場合、自動で置換されます：

| 置換元 | 置換先 |
|-------|-------|
| MS明朝 Bold | BIZ UDゴシック Regular |
| ＭＳ明朝 Bold | BIZ UDゴシック Regular |
| MS明朝（表内） | BIZ UDゴシック Regular |
| Mincho（表内） | BIZ UDゴシック Regular |

---

## 設定のカスタマイズ

スクリプト冒頭の `CONFIG` オブジェクトで各種設定を変更できます。

```javascript
var CONFIG = {
    autoCreatePages: true,      // ページ自動追加の有効/無効
    maxSpreads: 100,            // 最大追加見開き数
    masterPagePrefix: "H",      // マスターページの接頭辞
    masterPageName: "本文マスター", // マスターページ名

    styleMapping: {             // スタイル変換の対応表
        "大項目": "大見出し1",
        "小項目": "小項目",
        "標準": "Normal",
        "演習タイトル": "演習タイトル",
        "図表番号": "図番号",
        "リスト": "リスト",
        "番号": "番号リスト"
    },

    kokomokuSymbol: "□　",      // 小項目に追加する記号

    fallbackMargin: {           // マスターページにフレームがない場合の余白
        top: 36,
        bottom: 36,
        inside: 54,
        outside: 36
    },

    debugMode: true             // デバッグログの出力
};
```

### 設定変更の例

#### マスターページ名を変更する

```javascript
masterPagePrefix: "A",
masterPageName: "本文",
```
→ `A-本文` というマスターページを使用

#### スタイル変換を追加する

```javascript
styleMapping: {
    "大項目": "大見出し1",
    "小項目": "小項目",
    "標準": "Normal",
    "注釈": "脚注",    // ← 追加
    // ...
},
```

#### ページ自動追加を無効にする

```javascript
autoCreatePages: false,
```

---

## 関数リファレンス

スクリプト内の各関数の説明です。別のスクリプトを作成する際の参考にしてください。

### デバッグ関連

#### `debugLog(message)`

デバッグメッセージをExtendScript Toolkitのコンソールに出力します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| message | String | 出力するメッセージ |

```javascript
// 使用例
debugLog("処理を開始します");
```

> `CONFIG.debugMode` が `true` の場合のみ出力されます。

---

### Wordインポート関連

#### `configureWordImportPreferences()`

InDesignのWordインポート設定を構成します。

| 設定項目 | 値 | 説明 |
|---------|-----|------|
| removeFormatting | false | 書式を保持する |
| preserveGraphics | true | 画像を保持する |
| preserveLocalOverrides | true | ローカル上書きを保持する |
| importFootnotes | true | 脚注をインポートする |
| importEndnotes | true | 文末脚注をインポートする |
| importIndex | true | 索引をインポートする |
| importTOC | true | 目次をインポートする |
| importUnusedStyles | false | 未使用スタイルはインポートしない |
| useTypographersQuotes | true | タイポグラフィ引用符を使用 |

---

#### `detectEmbeddedObjectIssues(story)`

ストーリー内の埋め込みオブジェクト問題（孤立した□文字など）を検出します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| story | Story | 検査対象のストーリー |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| issueCount | Number | 検出された問題の件数 |

---

#### `importWordDocument(doc, wordFile, master)`

Word文書をInDesignドキュメントにインポートします。これがインポート処理のメイン関数です。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | インポート先のInDesignドキュメント |
| wordFile | File | インポートするWord文書 |
| master | MasterSpread | 新規ページに適用するマスターページ |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| result | Object | インポート結果のオブジェクト |

**戻り値オブジェクトの内容：**
```javascript
{
    spreadsCreated: Number,      // 追加された見開き数
    paragraphsImported: Number,  // インポートされた段落数
    stylesApplied: Number,       // 適用されたスタイル数
    kokomokuFixed: Number,       // □記号を追加した数
    importedStory: Story,        // インポートされたストーリー
    embeddedObjectIssues: Number // 埋め込みオブジェクト問題数
}
```

---

### テキストフレーム管理

#### `getOrCreateTextFrame(doc, page)`

指定ページでテキストフレームを取得または作成します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |
| page | Page | 対象ページ |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| textFrame | TextFrame | テキストフレーム（取得または新規作成） |

**処理の優先順位：**
1. マスターページのテキストフレームをオーバーライド
2. 既存のテキストフレームから最大のものを使用
3. 新規テキストフレームを作成

---

#### `overrideMasterTextFrame(page)`

マスターページのテキストフレームをオーバーライドして取得します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| page | Page | 対象ページ |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| textFrame | TextFrame / null | オーバーライドしたテキストフレーム。失敗時はnull |

---

#### `createTextFrame(doc, page)`

新規テキストフレームを作成します。見開きページ（左右）に応じて適切な余白を設定します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |
| page | Page | 対象ページ |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| textFrame | TextFrame | 新規作成されたテキストフレーム |

---

#### `autoFlowWithSpreads(doc, startFrame, master)`

テキストがオーバーフローしている場合、自動で見開きを追加してテキストを流し込みます。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |
| startFrame | TextFrame | 開始テキストフレーム（オーバーフロー状態） |
| master | MasterSpread | 新規ページに適用するマスターページ |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| spreadsCreated | Number | 追加された見開き数 |

**処理の流れ：**
1. オーバーフローを検出
2. 新しい見開きを追加
3. マスターページを適用
4. テキストフレームを連結
5. オーバーフローが解消するまで繰り返し

---

### スタイル変換

#### `applyStyleMapping(doc, importedStory)`

`CONFIG.styleMapping` に基づいて段落スタイルを変換します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |
| importedStory | Story | インポートされたストーリー |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| mappingCount | Number | 変換されたスタイル数 |

---

#### `removeLeadingSymbol(para, symbol)`

段落の先頭から指定した記号を削除します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| para | Paragraph | 対象の段落 |
| symbol | String | 削除する記号（例："■"） |

---

#### `addKokomokuSymbol(doc, importedStory)`

「小項目」スタイルの段落の先頭に□記号を追加します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |
| importedStory | Story | インポートされたストーリー |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| addCount | Number | 追加された記号の数 |

**スキップされるケース：**
- 既に□記号がある
- 段落内に表がある
- 段落内にインラインオブジェクトがある
- 空の段落

---

### フォント置換

#### `replaceFonts(importedStory)`

ストーリー内のMS明朝Boldフォントを BIZ UDゴシック に置換します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| importedStory | Story | 対象のストーリー |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| replaceCount | Number | 置換された文字数 |

---

#### `updateAllTableFonts(doc)`

ドキュメント内の全ての表で、MS明朝フォントをBIZ UDゴシックに置換します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| replaceCount | Number | 置換された文字数 |

---

### 表セルスタイル処理

#### `applyCodeStyleToTableCells(doc, importedStory)`

インポートされたストーリー内の表セルに「コード・コマンド」スタイルを適用します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |
| importedStory | Story | インポートされたストーリー |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| styleApplied | Number | スタイルを適用した段落数 |

---

### アンカーオブジェクト処理

#### `applyCodeStyleToAnchoredObjects(doc, importedStory)`

アンカーオブジェクト（図など）内のテキストに「コード・コマンド」スタイルを適用します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |
| importedStory | Story | インポートされたストーリー |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| styleApplied | Number | スタイルを適用した段落数 |

---

#### `processAnchoredItem(item, codeStyle)`

アンカーオブジェクト内の個別アイテムを処理します（再帰的に処理）。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| item | PageItem | 処理対象のアイテム |
| codeStyle | ParagraphStyle | 適用するスタイル |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| styleApplied | Number | スタイルを適用した段落数 |

**対応するアイテムタイプ：**
- Group（再帰的に内部を処理）
- TextFrame（段落にスタイルを適用）
- テキストコンテンツを持つアイテム

---

### ユーティリティ関数

#### `listMasterPages(doc)`

ドキュメント内のマスターページ名を一覧で取得します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| list | String | マスターページ名の一覧（改行区切り） |

```javascript
// 使用例
var masterList = listMasterPages(doc);
alert(masterList);
// 出力例:
// A-マスター
// H-本文マスター
// B-章扉
```

---

#### `getMasterPage(doc, masterName)`

名前を指定してマスターページを取得します。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |
| masterName | String | マスターページ名（例："H-本文マスター"） |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| master | MasterSpread / null | マスターページ。見つからない場合はnull |

---

#### `countParagraphs(doc)`

ドキュメント内の全段落数をカウントします。

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| doc | Document | 対象ドキュメント |

| 戻り値 | 型 | 説明 |
|--------|-----|------|
| count | Number | 段落数 |

---

### メイン処理

#### `main()`

スクリプトのエントリーポイントです。全体の処理フローを制御します。

**処理内容：**
1. ドキュメントが開かれているか確認
2. マスターページの存在確認
3. Word文書選択ダイアログを表示
4. 確認ダイアログを表示
5. 再描画を無効化して処理を高速化
6. Word文書をインポート
7. 各種スタイル・フォント処理を実行
8. 結果ダイアログを表示

---

## トラブルシューティング

### エラー：「マスターページが見つかりません」

**原因：** `H-本文マスター` という名前のマスターページがドキュメントに存在しない

**解決方法：**
1. ページパネルでマスターページ名を確認
2. スクリプトの `CONFIG.masterPagePrefix` と `CONFIG.masterPageName` を実際のマスターページ名に合わせて変更

---

### エラー：「テキストフレームを作成できませんでした」

**原因：** ページへのテキストフレーム配置に失敗した

**解決方法：**
1. ドキュメントのページ設定を確認
2. マスターページにテキストフレームが正しく配置されているか確認

---

### 警告：「埋め込みオブジェクト問題を検出」

**原因：** Word内の埋め込み表がInDesignで正しく変換されなかった

**解決方法：**
1. Word文書を開く
2. 問題の表を選択
3. 右クリック →「表に変換」
4. Word文書を保存
5. 再度インポート

---

### 段落スタイルが変換されない

**原因：** Word文書のスタイル名がマッピングと一致していない

**解決方法：**
1. Word文書のスタイル名を確認
2. `CONFIG.styleMapping` に対応するマッピングを追加

---

### フォントが置換されない

**原因：**
- BIZ UDゴシックがインストールされていない
- フォント名が想定と異なる

**解決方法：**
1. BIZ UDゴシックがインストールされているか確認
2. インストールされている場合、スクリプト内のフォント名を確認・修正

---

### デバッグログを確認したい

**方法：**
1. ExtendScript Toolkitでスクリプトを開く
2. ターゲットアプリケーションをInDesignに設定
3. スクリプトを実行
4. コンソールパネルにログが表示される

> InDesign 2025以降では、ExtendScript Toolkitの代わりにVSCodeの「ExtendScript Debugger」拡張機能を使用することも可能です。

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12 | 初版作成 |

---

## 関連情報

- [Adobe InDesign スクリプティングガイド](https://www.adobe.com/devnet/indesign/documentation.html)
- [ExtendScript API リファレンス](https://extendscript.docsforadobe.dev/)
